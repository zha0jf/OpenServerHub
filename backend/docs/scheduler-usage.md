# 定时任务功能使用说明

## 功能概述

后台异步定时刷新服务器电源状态功能已经实现，支持以下特性：

- **自动刷新**：每分钟自动刷新所有服务器的电源状态
- **手动刷新**：通过API接口手动触发刷新
- **状态监控**：查看定时任务运行状态和下次执行时间
- **并发控制**：支持多服务器并发刷新，提高效率
- **错误处理**：完善的错误处理和日志记录

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 定时任务配置
POWER_STATE_REFRESH_INTERVAL=1        # 刷新间隔（分钟）
POWER_STATE_REFRESH_ENABLED=true      # 是否启用自动刷新
```

### 依赖安装

确保已安装 `apscheduler` 依赖：

```bash
pip install apscheduler==3.10.4
```

## API接口

### 1. 获取定时任务状态

```bash
GET /api/v1/scheduler/status
```

返回示例：
```json
{
  "success": true,
  "data": {
    "running": true,
    "job_id": "power_state_refresh",
    "next_run_time": "2025-09-22T17:02:10.538625+08:00",
    "interval_minutes": 1
  }
}
```

### 2. 手动刷新电源状态

```bash
POST /api/v1/scheduler/refresh-power-state
```

返回示例：
```json
{
  "success": true,
  "message": "电源状态刷新任务已提交"
}
```

## 日志监控

定时任务的执行日志会显示在服务控制台中，包含以下信息：

- 任务启动和停止时间
- 每次刷新的服务器数量和结果统计
- 单个服务器刷新的成功/失败状态
- 错误信息和异常处理

示例日志输出：
```
INFO - 电源状态定时刷新服务已启动，刷新间隔：1分钟
INFO - 开始刷新所有服务器电源状态
INFO - 找到 14 台服务器需要刷新电源状态
INFO - 电源状态刷新完成 - 成功: 10, 失败: 4, 总计: 14, 耗时: 15.23秒
```

## 功能特点

1. **异步执行**：使用异步编程模式，不会阻塞主服务
2. **并发处理**：支持多服务器并发刷新，提高效率
3. **错误隔离**：单个服务器刷新失败不会影响其他服务器
4. **自动重试**：内置错误处理和重试机制
5. **资源管理**：合理管理数据库连接和IPMI连接池

## 注意事项

1. 确保IPMI连接配置正确，否则刷新会失败
2. 定时任务默认启用，可以通过设置 `POWER_STATE_REFRESH_ENABLED=false` 禁用
3. 刷新间隔建议设置为1-5分钟，避免过于频繁的查询
4. 如果服务器数量较多，可以适当增加刷新间隔时间

## 故障排查

如果定时任务无法正常工作，请检查：

1. 查看服务日志中的错误信息
2. 确认IPMI服务配置是否正确
3. 检查数据库连接是否正常
4. 验证单个服务器的IPMI连接是否可用

可以通过手动刷新API测试单个服务器的连接状态。