# 审计日志功能设计文档

## 概述

OpenServerHub 审计日志功能用于记录和追踪系统中的所有关键操作（如用户登录、电源控制、服务器管理等），实现完整的操作审计能力。

## 设计原则

1. **完整性**: 记录所有关键操作
2. **追踪性**: 能够追踪每个操作的执行者、时间、结果
3. **安全性**: 防止敏感信息泄露，仅admin用户可访问
4. **性能**: 不影响主业务逻辑执行
5. **可维护性**: 易于扩展新的操作类型

## 核心数据模型

### AuditLog 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 日志ID (主键) |
| action | Enum | 操作类型 |
| status | Enum | 操作状态 (成功/失败/部分成功) |
| operator_id | Integer | 操作者用户ID |
| operator_username | String | 操作者用户名 |
| resource_type | String | 资源类型 (user/server/group等) |
| resource_id | Integer | 资源ID |
| resource_name | String | 资源名称 |
| action_details | Text(JSON) | 操作参数 |
| result | Text(JSON) | 操作结果 |
| error_message | Text | 错误信息 |
| ip_address | String | 客户端IP |
| user_agent | String | User Agent |
| created_at | DateTime | 创建时间 |

### 索引设计

- `idx_audit_logs_action`: 操作类型查询优化
- `idx_audit_logs_operator_id`: 操作者查询优化
- `idx_audit_logs_resource_type`: 资源类型查询优化
- `idx_audit_logs_resource_id`: 资源ID查询优化
- `idx_audit_logs_created_at`: 时间范围查询优化

## 支持的操作类型

### 用户认证 (3种)
- LOGIN: 登录成功
- LOGOUT: 登出
- LOGIN_FAILED: 登录失败

### 用户管理 (4种)
- USER_CREATE: 创建用户
- USER_UPDATE: 更新用户
- USER_DELETE: 删除用户
- USER_ROLE_CHANGE: 修改用户角色

### 服务器管理 (4种)
- SERVER_CREATE: 创建服务器
- SERVER_UPDATE: 更新服务器
- SERVER_DELETE: 删除服务器
- SERVER_IMPORT: 导入服务器

### 电源控制 (5种)
- POWER_ON: 开机
- POWER_OFF: 关机
- POWER_RESTART: 重启
- POWER_FORCE_OFF: 强制关机
- POWER_FORCE_RESTART: 强制重启

### LED控制 (2种)
- LED_ON: 点亮定位灯
- LED_OFF: 关闭定位灯

### 批量操作 (2种)
- BATCH_POWER_CONTROL: 批量电源控制
- BATCH_GROUP_CHANGE: 批量修改分组

### 监控管理 (2种)
- MONITORING_ENABLE: 启用监控
- MONITORING_DISABLE: 禁用监控

### 设备发现 (2种)
- DISCOVERY_START: 开始扫描
- DISCOVERY_COMPLETE: 完成扫描

### 分组管理 (3种)
- GROUP_CREATE: 创建分组
- GROUP_UPDATE: 更新分组
- GROUP_DELETE: 删除分组

**总计: 35种操作类型**

## 架构设计

### 分层架构

```
API 层
├─ endpoints/audit_logs.py (REST API 接口)
└─ endpoints/*.py (其他API + 审计记录调用)

业务服务层
└─ services/audit_log.py (AuditLogService)

数据模型层
├─ models/audit_log.py (数据模型)
└─ schemas/audit_log.py (API Schema)

数据持久层
└─ audit_logs 表
```

### 集成点

1. **认证模块** (`endpoints/auth.py`)
   - 记录登录尝试 (成功/失败)
   - 记录登出操作

2. **服务器管理模块** (`endpoints/servers.py`)
   - 记录电源控制操作
   - 记录操作结果 (成功/失败)

3. **用户管理模块** (待集成)
   - 记录用户创建/删除/修改

4. **设备发现模块** (待集成)
   - 记录扫描开始/完成

## API 设计

### 获取审计日志列表

```http
GET /api/v1/audit-logs
```

**查询参数:**
- `skip` (int): 分页偏移，默认0
- `limit` (int): 每页数量，默认100，最大1000
- `action` (string): 操作类型过滤
- `operator_id` (int): 操作者ID过滤
- `resource_type` (string): 资源类型过滤
- `resource_id` (int): 资源ID过滤
- `start_date` (string): 开始日期 (ISO格式)
- `end_date` (string): 结束日期 (ISO格式)

**响应:**
```json
{
  "items": [{
    "id": 1,
    "action": "LOGIN",
    "status": "success",
    "operator_id": 1,
    "operator_username": "admin",
    "resource_type": "user",
    "resource_id": 1,
    "resource_name": "admin",
    "ip_address": "127.0.0.1",
    "created_at": "2025-01-12T10:22:08"
  }],
  "total": 100,
  "skip": 0,
  "limit": 100
}
```

### 获取日志详情

```http
GET /api/v1/audit-logs/{log_id}
```

### 获取统计摘要

```http
GET /api/v1/audit-logs/stats/summary?days=7
```

**响应包含:**
- 总操作数
- 失败操作数
- 成功率
- 各操作类型分布
- 活跃用户排行

### 导出审计日志为CSV

```http
GET /api/v1/audit-logs/export/csv
```

**查询参数:**
- 所有列表查询参数 (支持相同过滤条件)
- `skip` (int): 分页偏移，默认0
- `limit` (int): 每页数量，默认10000，最大100000

**响应:**
- CSV格式文件下载
- 文件名为 `audit_logs.csv`

### 导出审计日志为Excel

```http
GET /api/v1/audit-logs/export/excel
```

**查询参数:**
- 所有列表查询参数 (支持相同过滤条件)
- `skip` (int): 分页偏移，默认0
- `limit` (int): 每页数量，默认10000，最大100000

**响应:**
- Excel格式文件下载
- 文件名为 `audit_logs.xlsx`
- 包含美化样式 (表头颜色、列宽等)

### 清理过期审计日志

```http
POST /api/v1/audit-logs/cleanup
```

**请求体:**
```json
{
  "days": 30
}
```

**响应:**
```json
{
  "deleted_count": 150,
  "message": "成功删除150条2025-01-12之前的审计日志"
}
```

## 权限设计

- 仅 **Admin** 角色用户可访问审计日志API
- 通过 `get_current_admin_user` 进行权限检查
- JWT 认证令牌验证

## 安全性考虑

1. **敏感信息保护**
   - 不记录用户密码
   - 不记录IPMI凭证
   - 不记录API令牌

2. **数据追踪**
   - 记录客户端IP地址
   - 记录User Agent
   - 记录操作时间

3. **操作完整性**
   - 记录操作结果（成功/失败）
   - 记录错误信息
   - 记录操作参数

## 扩展机制

### 添加新操作类型

1. 在 `AuditAction` 枚举中添加新类型
2. 在相应API端点调用 `audit_service.create_log()` 或专用方法
3. 更新文档和测试

### 添加新记录方法

在 `AuditLogService` 中添加专用方法：
```python
def log_custom_operation(self, ...):
    """记录自定义操作"""
    return self.create_log(...)
```

## 性能考虑

1. **数据库索引**: 5个关键索引优化查询性能
2. **分页查询**: 支持大数据量查询
3. **异步写入**: 不阻塞主业务逻辑
4. **数据留存**: 无自动清理，定期维护

## 后续改进

1. **日志导出**: CSV/Excel 格式 ✅ (已完成)
2. **告警机制**: 异常操作实时告警
3. **ELK集成**: 日志集中存储和分析
4. **日志保留**: 自动清理过期日志 ✅ (已完成)
5. **高可用**: 日志副本存储
