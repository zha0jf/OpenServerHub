# 审计日志使用指南

## 功能简介

审计日志功能自动记录系统中的所有关键操作（登录、电源控制、用户管理等），帮助管理员追踪谁在何时做了什么。所有审计日志只能通过Web管理界面查看，且仅限管理员用户访问。

## 访问审计日志

1. 登录OpenServerHub管理系统（需要管理员权限）
2. 在左侧导航菜单中点击"审计日志"图标
3. 系统将自动加载最近的审计日志记录

界面分为三个主要区域：
- **顶部统计面板**：显示关键统计数据
- **操作工具栏**：提供筛选、导出、清理等功能
- **日志列表**：展示详细的审计日志记录

## 查看审计日志

进入审计日志页面后，系统会自动显示最近的操作记录。您可以通过以下方式进行筛选：

### 按日期筛选

1. 在工具栏的日期选择器中选择开始日期和结束日期
2. 系统将自动刷新，只显示选定日期范围内的日志

### 按操作类型筛选

1. 在工具栏的"选择操作类型"下拉框中选择特定操作类型
2. 系统将自动刷新，只显示该类型的日志
3. 支持的操作类型包括：登录、登出、开机、关机、重启、创建用户、删除用户等

### 按资源类型筛选

1. 在工具栏的"选择资源类型"下拉框中选择特定资源类型
2. 系统将自动刷新，只显示对该类型资源的操作日志
3. 支持的资源类型包括：用户、服务器、组、发现任务等

### 查看日志详情

1. 在日志列表中找到想要查看详情的记录
2. 点击该行右侧的"眼睛"图标
3. 系统将打开一个抽屉窗口，显示该日志的详细信息，包括：
   - 操作类型和状态
   - 操作者信息
   - 资源信息
   - 操作时间和客户端信息
   - 操作详情和结果（如果有的话）
   - 错误信息（如果是失败的操作）

## 导出审计日志

审计日志支持导出为CSV和Excel格式，便于离线分析和存档：

### 导出为CSV格式

1. 点击工具栏中的"导出CSV"按钮
2. 系统将根据当前筛选条件导出日志
3. 浏览器将自动下载CSV文件，文件名包含导出时间戳

### 导出为Excel格式

1. 点击工具栏中的"导出Excel"按钮
2. 系统将根据当前筛选条件导出日志
3. 浏览器将自动下载Excel文件，文件名包含导出时间戳

> 注意：导出功能会包含所有筛选条件，如果您只想导出特定时间段或特定类型的操作，请先进行筛选再导出。

## 支持的操作类型

系统记录多种类型的操作，主要包括：

### 认证相关
- **LOGIN**: 用户登录成功
- **LOGOUT**: 用户主动登出
- **LOGIN_FAILED**: 用户登录失败

### 电源控制相关
- **POWER_ON**: 服务器开机
- **POWER_OFF**: 服务器关机
- **POWER_RESTART**: 服务器重启
- **POWER_FORCE_OFF**: 强制关机
- **POWER_FORCE_RESTART**: 强制重启

### 服务器管理相关
- **SERVER_CREATE**: 创建服务器记录
- **SERVER_UPDATE**: 更新服务器记录
- **SERVER_DELETE**: 删除服务器记录
- **SERVER_IMPORT**: 批量导入服务器

### 用户管理相关
- **USER_CREATE**: 创建用户
- **USER_UPDATE**: 更新用户信息
- **USER_DELETE**: 删除用户
- **USER_ROLE_CHANGE**: 修改用户角色

### 组管理相关
- **GROUP_CREATE**: 创建服务器组
- **GROUP_UPDATE**: 更新服务器组
- **GROUP_DELETE**: 删除服务器组

### 监控相关
- **MONITORING_ENABLE**: 启用监控
- **MONITORING_DISABLE**: 禁用监控

### 设备发现相关
- **DISCOVERY_START**: 启动设备发现
- **DISCOVERY_COMPLETE**: 设备发现完成

### 批量操作相关
- **BATCH_POWER_CONTROL**: 批量电源控制
- **BATCH_GROUP_CHANGE**: 批量组变更

### 审计日志相关
- **AUDIT_LOG_EXPORT**: 导出审计日志
- **AUDIT_LOG_CLEANUP**: 清理审计日志
- **AUDIT_LOG_VIEW**: 查看审计日志

### 数据库备份相关
- **BACKUP_CREATE**: 创建数据库备份
- **BACKUP_DELETE**: 删除数据库备份
- **BACKUP_RESTORE**: 恢复数据库备份
- **BACKUP_VERIFY**: 验证数据库备份
- **BACKUP_DOWNLOAD**: 下载数据库备份

## 常见使用场景

### 查看登录活动

1. 在操作类型筛选器中选择"login"、"logout"或"login_failed"
2. 或者不使用筛选器，直接在日志列表中查找登录相关记录

### 查看服务器电源操作历史

1. 在操作类型筛选器中选择"power_on"、"power_off"或"power_restart"
2. 可结合资源类型筛选器选择特定服务器

### 查看用户管理操作

1. 在操作类型筛选器中选择"user_create"、"user_update"、"user_delete"或"user_role_change"
2. 可以查看所有用户管理活动的历史记录

### 查看失败的操作

1. 在日志列表的状态列中，失败的操作会以红色标签显示
2. 可以点击详情查看具体的错误信息

## 清理过期日志

为了节省存储空间，系统提供了清理过期审计日志的功能：

1. 点击工具栏中的"清理过期日志"按钮（红色危险按钮）
2. 在弹出的确认对话框中输入要保留的日志天数
3. 点击"确定"执行清理操作
4. 系统将删除超过指定天数的所有日志记录

> ⚠️ 注意：清理操作不可逆，请谨慎操作。建议在清理前先导出重要日志。

## 权限说明

审计日志功能仅对管理员（Admin）角色开放：
- ✅ **Admin**: 可访问所有审计日志功能
- ❌ **Operator**: 无权访问审计日志
- ❌ **User**: 无权访问审计日志
- ❌ **ReadOnly**: 无权访问审计日志

普通用户尝试访问审计日志页面时将被拒绝访问。

## 记录的信息

每条审计日志记录包含以下信息：

### 基本信息
- **操作类型**: 如登录、开机、创建用户等
- **操作状态**: 成功、失败或部分成功
- **操作时间**: 操作发生的精确时间戳

### 操作者信息
- **用户名**: 执行操作的用户名称
- **用户ID**: 执行操作的用户唯一标识

### 资源信息
- **资源类型**: 操作针对的资源类型（用户、服务器等）
- **资源ID**: 资源的唯一标识
- **资源名称**: 资源的名称（如果有）

### 客户端信息
- **IP地址**: 发起操作的客户端IP地址
- **User Agent**: 客户端浏览器和操作系统信息

### 详细信息
- **操作详情**: 操作的具体参数（以JSON格式存储）
- **操作结果**: 操作的执行结果（以JSON格式存储）
- **错误信息**: 如果操作失败，记录具体的错误信息

## 统计信息

审计日志页面顶部显示关键统计信息：

- **总操作数**: 系统记录的所有操作总数
- **失败操作**: 执行失败的操作数量
- **成功率**: 成功操作占总操作的百分比
- **操作类型分布**: 最常见的操作类型排行
- **活跃用户排行**: 操作最频繁的用户排行

这些统计信息可以帮助管理员快速了解系统的整体运行状况和用户活动情况。

## 故障排除

**问题: 无法访问审计日志页面**
- 确保您具有管理员权限
- 尝试刷新页面或重新登录

**问题: 筛选结果为空**
- 检查日期范围是否合理
- 尝试清除筛选条件，查看是否有数据
- 确认系统中有相关操作发生

**问题: 导出功能失败**
- 检查网络连接是否正常
- 确认浏览器允许下载文件
- 尝试减少导出数据量（通过筛选条件）

## 最佳实践

1. **定期导出**: 建议定期导出审计日志进行备份
2. **及时清理**: 根据存储策略定期清理过期日志
3. **重点关注失败操作**: 定期检查失败操作，排查系统问题
4. **监控异常活动**: 关注异常时间段的大量操作

## 相关文档

- 详细设计文档: `docs/feature/审计日志设计.md`
- API开发文档: `docs/development/审计日志API开发.md`

## 更新日志

审计日志功能将持续改进，新增功能将在此处更新。
