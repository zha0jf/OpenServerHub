# 设备发现功能使用指南

## 功能概述

设备发现功能是OpenServerHub系统中用于自动发现网络中BMC设备的重要功能。该功能支持多种发现方式，包括网络扫描、批量导入和CSV文件导入。

## 主要功能

### 1. 网络范围扫描

#### 支持的网络格式

- **CIDR格式**: `192.168.1.0/24`
  - 表示扫描192.168.1.1到192.168.1.254的所有IP地址
  
- **IP范围格式**: `192.168.1.1-192.168.1.100`
  - 表示扫描192.168.1.1到192.168.1.100的所有IP地址
  
- **逗号分隔的IP列表**: `192.168.1.100,192.168.1.101,192.168.1.102`
  - 表示扫描指定的多个IP地址

#### 扫描参数

- **IPMI端口**: 默认623，可自定义1-65535范围内的端口
- **超时时间**: 默认3秒，可设置1-30秒
- **并发数**: 默认5，可设置1、3、5、10个并发连接

### 2. BMC设备自动识别

系统会自动尝试使用常见的默认凭据连接BMC设备：

- 超微(Supermicro): `root` / `0penBmc`, `ADMIN` / `ADMIN`
- OpenBMC / 通用: `root` / `0penBmc`
- 浪潮(Inspur): `root` / `superuser`
- 华为(Huawei): `Administrator` / `Admin@9000`, `root` / `Huawei12#$`
- 通用默认: `ADMIN` / `ADMIN`, `admin` / `admin`, `root` / `calvin`, `Administrator` / `superuser`
- 无认证: （空用户名） / （空密码）

对于成功连接的设备，系统会自动获取以下信息：
- 制造商信息
- 设备型号
- 序列号
- BMC版本
- 可用的认证凭据

### 3. 批量导入服务器

发现设备后，可以批量导入到服务器管理系统中：

1. 在设备列表中选择要导入的设备
2. 点击"批量导入"按钮
3. 设置默认IPMI凭据（对于未发现凭据的设备）
4. 选择目标分组（可选）
5. 确认导入

### 4. CSV文件导入

支持通过CSV文件批量导入服务器信息：

#### CSV文件格式

```csv
name,ipmi_ip,ipmi_username,ipmi_password,ipmi_port,manufacturer,model,serial_number,description
Server-001,192.168.1.100,admin,password,623,Dell,PowerEdge R740,ABC123,Production server
Server-002,192.168.1.101,root,calvin,623,HP,ProLiant DL380,DEF456,Development server
```

#### 必需字段

- `name`: 服务器名称
- `ipmi_ip`: IPMI IP地址
- `ipmi_username`: IPMI用户名
- `ipmi_password`: IPMI密码

#### 可选字段

- `ipmi_port`: IPMI端口（默认623）
- `manufacturer`: 制造商
- `model`: 型号
- `serial_number`: 序列号
- `description`: 描述信息

## 使用步骤

### 1. 网络扫描发现

1. 登录OpenServerHub系统
2. 进入"设备发现"页面
3. 在"网络扫描配置"中输入要扫描的网络范围
4. 调整扫描参数（可选）
5. 点击"开始扫描"按钮
6. 等待扫描完成，查看发现的设备列表

### 2. 批量导入设备

1. 在发现的设备列表中勾选要导入的设备
2. 点击"批量导入"按钮
3. 填写默认IPMI凭据（如果需要）
4. 选择目标分组（如果需要）
5. 点击"确认导入"

### 3. CSV文件导入

#### 方式一：文本导入
1. 点击"CSV导入"按钮
2. 在文本框中粘贴CSV内容
3. 选择目标分组（可选）
4. 点击"导入数据"

#### 方式二：文件上传
1. 点击"CSV导入"按钮
2. 在上传区域拖拽或点击选择CSV文件
3. 文件会自动导入

#### 方式三：下载模板
1. 点击"下载模板"按钮
2. 下载CSV模板文件
3. 编辑模板文件添加服务器信息
4. 通过文件上传方式导入

## 功能特点

### 智能识别
- 自动识别BMC设备类型
- 尝试常见默认凭据
- 获取设备硬件信息

### 并发扫描
- 支持多线程并发扫描
- 可配置并发数量
- 实时显示扫描进度

### 错误处理
- 详细的错误信息提示
- 失败设备的具体错误原因
- 部分成功的友好提示

### 数据验证
- IP地址格式验证
- 用户名密码长度验证
- 端口范围验证
- 重复数据检查

## 注意事项

1. **网络权限**: 确保系统有权限访问目标网络段
2. **IPMI服务**: 目标设备需要启用IPMI服务
3. **防火墙**: 确保IPMI端口（默认623）未被防火墙阻拦
4. **扫描范围**: 大网段扫描可能耗时较长，建议合理设置扫描范围
5. **并发数量**: 过高的并发数可能导致网络拥堵或被目标设备限制
6. **默认凭据**: 生产环境中建议修改默认IPMI密码

## 故障排查

### 扫描无结果
- 检查网络连通性
- 确认IPMI端口是否开放
- 验证网络范围格式是否正确

### 导入失败
- 检查服务器名称是否重复
- 验证IP地址是否已存在
- 确认IPMI凭据是否正确

### CSV导入错误
- 检查CSV文件格式
- 验证必需字段是否完整
- 确认文件编码为UTF-8

## API接口

设备发现功能提供以下API接口：

- `POST /api/v1/discovery/network-scan` - 网络扫描
- `POST /api/v1/discovery/batch-import` - 批量导入
- `POST /api/v1/discovery/csv-import` - CSV文件导入
- `POST /api/v1/discovery/csv-import-text` - CSV文本导入
- `GET /api/v1/discovery/csv-template` - 下载CSV模板
- `GET /api/v1/discovery/network-examples` - 获取网络格式示例

详细的API文档可以通过访问 `/docs` 页面查看Swagger UI。