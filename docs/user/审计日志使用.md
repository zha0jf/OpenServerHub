# 审计日志快速开始

## 30秒了解审计日志

审计日志功能自动记录系统中的所有关键操作（登录、电源控制等），帮助你追踪谁在何时做了什么。

## 初始化

### 1. 初始化数据库

```bash
cd backend
python init_db.py
```

这会创建审计日志表及其他必要的数据库结构。

### 2. 启动应用

```bash
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## 使用审计日志

### 1. 登录获取Token

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123"
```

响应:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@openshub.com",
    "role": "admin"
  }
}
```

### 2. 查询审计日志

```bash
# 所有日志
curl -H "Authorization: Bearer <token>" \
  http://localhost:8000/api/v1/audit-logs

# 登录日志
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs?action=LOGIN&limit=10"

# 特定日期的操作
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs?start_date=2025-01-12&end_date=2025-01-12"

# 统计摘要
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs/stats/summary?days=7"
```

## API 端点

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/audit-logs` | 获取日志列表 |
| GET | `/audit-logs/{log_id}` | 获取日志详情 |
| GET | `/audit-logs/stats/summary` | 获取统计摘要 |
| GET | `/audit-logs/export/csv` | 导出为CSV |
| GET | `/audit-logs/export/excel` | 导出为Excel |
| POST | `/audit-logs/cleanup` | 清理过期日志 |

## 支持的操作类型

| 类别 | 操作 | 说明 |
|------|------|------|
| 认证 | LOGIN | 登录成功 |
| | LOGOUT | 登出 |
| | LOGIN_FAILED | 登录失败 |
| 电源 | POWER_ON | 开机 |
| | POWER_OFF | 关机 |
| | POWER_RESTART | 重启 |
| 服务器 | SERVER_CREATE | 创建服务器 |
| | SERVER_DELETE | 删除服务器 |
| 用户 | USER_CREATE | 创建用户 |
| | USER_DELETE | 删除用户 |

*更多操作类型见详细文档*

## 常见查询

### 查询登录日志
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs?action=LOGIN"
```

### 查询特定用户的所有操作
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs?operator_id=1"
```

### 查询特定服务器的所有操作
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs?resource_type=server&resource_id=1"
```

### 查询失败的操作
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs" | \
  jq '.items[] | select(.status == "failed")'
```

## 导出审计日志

### 导出为CSV格式
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs/export/csv" \
  -o audit_logs.csv
```

### 导出为Excel格式
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs/export/excel" \
  -o audit_logs.xlsx
```

### 带过滤条件的导出
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8000/api/v1/audit-logs/export/csv?action=LOGIN&start_date=2025-01-01&end_date=2025-01-31" \
  -o login_logs.csv
```

## 清理过期日志

### 清理30天前的日志
```bash
curl -X POST http://localhost:8000/api/v1/audit-logs/cleanup \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"days": 30}'
```

## 权限说明

- ✅ **Admin**: 可访问所有审计日志
- ❌ **Operator**: 无权访问
- ❌ **User**: 无权访问
- ❌ **ReadOnly**: 无权访问

## 记录的信息

每条日志包含：
- **操作信息**: 操作类型、成功/失败状态
- **操作者**: 用户ID、用户名
- **资源**: 类型、ID、名称
- **客户端**: IP地址、User Agent
- **时间**: 操作发生的时间戳
- **详情**: 操作参数 (JSON)
- **结果**: 操作结果 (JSON)
- **错误**: 失败时的错误信息

## 响应示例

```json
{
  "items": [
    {
      "id": 1,
      "action": "LOGIN",
      "status": "success",
      "operator_id": 1,
      "operator_username": "admin",
      "resource_type": "user",
      "resource_id": 1,
      "resource_name": "admin",
      "action_details": null,
      "result": null,
      "error_message": null,
      "ip_address": "127.0.0.1",
      "user_agent": "curl/7.68.0",
      "created_at": "2025-01-12T10:22:08"
    }
  ],
  "total": 1,
  "skip": 0,
  "limit": 100
}
```

## 故障排除

**问题: 无法访问审计日志API**
- 确保用户是 Admin 角色
- 检查 Token 是否有效

**问题: 查询返回空结果**
- 检查日期范围是否正确
- 尝试不带过滤条件的查询

**问题: 没有记录登录日志**
- 确保数据库已初始化: `python init_db.py`
- 检查数据库中是否存在 `audit_logs` 表

## 下一步

1. 查看详细设计: `docs/feature/审计日志设计.md`
2. 查看API开发: `docs/development/审计日志API开发.md`
3. 查看完成清单: 了解所有实现的功能

## 更多信息

- 详细文档: 见 `/docs` 目录
- API文档: 访问 `http://localhost:8000/docs` (Swagger UI)
- 源代码: `backend/app/services/audit_log.py`
